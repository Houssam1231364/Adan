import 'package:flutter/material.dart';
import 'package:geolocator/geolocator.dart';
import 'package:flutter_qiblah/flutter_qiblah.dart';
import 'package:intl/intl.dart';
import 'package:http/http.dart' as http;
import 'dart:math';
import 'dart:async';
import 'dart:convert';

void main() => runApp(const PrayerApp());

class PrayerApp extends StatelessWidget {
  const PrayerApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'أذان متطور',
      theme: ThemeData(
        fontFamily: 'Amiri',
        colorScheme: ColorScheme.fromSeed(
          seedColor: Colors.blue,
          brightness: Brightness.light,
        ),
        useMaterial3: true,
      ),
      darkTheme: ThemeData(
        fontFamily: 'Amiri',
        colorScheme: ColorScheme.fromSeed(
          seedColor: Colors.blueGrey,
          brightness: Brightness.dark,
        ),
        useMaterial3: true,
      ),
      home: const HomeScreen(),
    );
  }
}

class HomeScreen extends StatefulWidget {
  const HomeScreen({super.key});

  @override
  State<HomeScreen> createState() => _HomeScreenState();
}

class _HomeScreenState extends State<HomeScreen> {
  Position? _currentPosition;
  double _qiblahDirection = 0;
  Map<String, String>? _prayerTimes;
  String _errorMessage = '';
  bool _isLoading = true;
  bool _isDarkMode = false;

  final List<String> _prayerNames = [
    'الفجر',
    'الشروق',
    'الظهر',
    'العصر',
    'المغرب',
    'العشاء'
  ];

  @override
  void initState() {
    super.initState();
    _initializeApp();
  }

  Future<void> _initializeApp() async {
    try {
      await _checkLocationPermissions();
      await _getLocation();
      await _calculateQibla();
      await _getPrayerTimes();
    } catch (e) {
      setState(() {
        _errorMessage = 'حدث خطأ: ${e.toString()}';
        _isLoading = false;
      });
    }
  }

  Future<void> _checkLocationPermissions() async {
    bool serviceEnabled = await Geolocator.isLocationServiceEnabled();
    if (!serviceEnabled) {
      throw Exception('الرجاء تفعيل خدمة الموقع');
    }

    LocationPermission permission = await Geolocator.checkPermission();
    if (permission == LocationPermission.denied) {
      permission = await Geolocator.requestPermission();
      if (permission != LocationPermission.whileInUse &&
          permission != LocationPermission.always) {
        throw Exception('تم رفض إذن الموقع');
      }
    }
  }

  Future<void> _getLocation() async {
    try {
      Position position = await Geolocator.getCurrentPosition(
        desiredAccuracy: LocationAccuracy.best,
      );
      setState(() => _currentPosition = position);
    } on Exception catch (e) {
      throw Exception('فشل في الحصول على الموقع: $e');
    }
  }

  Future<void> _getPrayerTimes() async {
    if (_currentPosition == null) return;

    final url = Uri.https(
      'api.aladhan.com',
      '/v1/timings/${DateFormat('dd-MM-yyyy').format(DateTime.now())}',
      {
        'latitude': _currentPosition!.latitude.toStringAsFixed(4),
        'longitude': _currentPosition!.longitude.toStringAsFixed(4),
        'method': '4',
      },
    );

    try {
      final response = await http.get(url).timeout(const Duration(seconds: 10));
      
      if (response.statusCode == 200) {
        final data = jsonDecode(response.body)['data']['timings'] as Map<String, dynamic>;
        setState(() {
          _prayerTimes = data.map((key, value) => MapEntry(key, value.toString()));
          _isLoading = false;
        });
      } else {
        throw Exception('فشل في جلب البيانات: ${response.statusCode}');
      }
    } on TimeoutException {
      throw Exception('انتهى وقت الانتظار');
    }
  }

  Future<void> _calculateQibla() async {
    if (_currentPosition == null) return;
    
    try {
      final qiblah = await FlutterQiblah.qiblah(
        latitude: _currentPosition!.latitude,
        longitude: _currentPosition!.longitude,
      );
      setState(() => _qiblahDirection = qiblah.direction);
    } on Exception catch (e) {
      throw Exception('خطأ في حساب القبلة: $e');
    }
  }

  void _toggleDarkMode(bool value) {
    setState(() {
      _isDarkMode = value;
    });
  }

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      theme: _isDarkMode ? ThemeData.dark() : ThemeData.light(),
      home: Scaffold(
        appBar: AppBar(
          title: const Text('أذان متطور'),
          actions: [
            IconButton(
              icon: const Icon(Icons.refresh),
              onPressed: _initializeApp,
            ),
            IconButton(
              icon: const Icon(Icons.settings),
              onPressed: () => Navigator.push(
                context,
                MaterialPageRoute(
                  builder: (context) => SettingsScreen(
                    isDarkMode: _isDarkMode,
                    onDarkModeChanged: _toggleDarkMode,
                  ),
                ),
              ),
            ),
          ],
        ),
        body: _buildContent(),
      ),
    );
  }

  Widget _buildContent() {
    if (_isLoading) {
      return const Center(child: CircularProgressIndicator());
    }

    if (_errorMessage.isNotEmpty) {
      return Center(child: Text(_errorMessage, style: const TextStyle(color: Colors.red)));
    }

    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        children: [
          _LocationInfo(position: _currentPosition!),
          const SizedBox(height: 20),
          PrayerTimesTable(prayerTimes: _prayerTimes!, prayerNames: _prayerNames),
          const SizedBox(height: 20),
          QiblaCompass(direction: _qiblahDirection),
        ],
      ),
    );
  }
}

class _LocationInfo extends StatelessWidget {
  final Position position;

  const _LocationInfo({required this.position});

  @override
  Widget build(BuildContext context) {
    return Card(
      child: ListTile(
        leading: const Icon(Icons.location_on),
        title: const Text('الموقع الحالي'),
        subtitle: Text(
          'خط العرض: ${position.latitude.toStringAsFixed(4)}\n'
          'خط الطول: ${position.longitude.toStringAsFixed(4)}',
        ),
      ),
    );
  }
}

class PrayerTimesTable extends StatelessWidget {
  final Map<String, String> prayerTimes;
  final List<String> prayerNames;

  const PrayerTimesTable({
    super.key,
    required this.prayerTimes,
    required this.prayerNames,
  });

  @override
  Widget build(BuildContext context) {
    return Card(
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          children: [
            const Text(
              'أوقات الصلاة',
              style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold),
            ),
            const SizedBox(height: 10),
            ...List.generate(prayerNames.length, (index) => _PrayerRow(
              prayerNames[index],
              prayerTimes.values.elementAt(index),
            )),
          ],
        ),
      ),
    );
  }
}

class _PrayerRow extends StatelessWidget {
  final String name;
  final String time;

  const _PrayerRow(this.name, this.time);

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 8),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(name, style: const TextStyle(fontSize: 16)),
          Text(time, style: const TextStyle(fontWeight: FontWeight.bold)),
        ],
      ),
    );
  }
}

class QiblaCompass extends StatelessWidget {
  final double direction;

  const QiblaCompass({super.key, required this.direction});

  @override
  Widget build(BuildContext context) {
    return Card(
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          children: [
            const Text(
              'اتجاه القبلة',
              style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold),
            ),
            const SizedBox(height: 20),
            SizedBox(
              width: 200,
              height: 200,
              child: Stack(
                alignment: Alignment.center,
                children: [
                  Image.asset('assets/compass.png'),
                  Transform.rotate(
                    angle: direction * (pi / 180),
                    child: Image.asset('assets/needle.png', width: 100),
                  ),
                ],
              ),
            ),
            const SizedBox(height: 10),
            Text('الزاوية: ${direction.toStringAsFixed(1)}°'),
          ],
        ),
      ),
    );
  }
}

class SettingsScreen extends StatelessWidget {
  final bool isDarkMode;
  final ValueChanged<bool> onDarkModeChanged;

  const SettingsScreen({
    super.key,
    required this.isDarkMode,
    required this.onDarkModeChanged,
  });

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('الإعدادات')),
      body: ListView(
        padding: const EdgeInsets.all(16),
        children: [
          SwitchListTile(
            title: const Text('الوضع الليلي'),
            value: isDarkMode,
            onChanged: onDarkModeChanged,
          ),
          ListTile(
            title: const Text('طريقة الحساب'),
            subtitle: const Text('رابطة العالم الإسلامي'),
            trailing: const Icon(Icons.arrow_forward_ios),
            onTap: () {},
          ),
        ],
      ),
    );
  }
}
